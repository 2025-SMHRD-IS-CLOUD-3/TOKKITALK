<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKKI TALK - 대화 분석</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            min-height: 100vh;
        }
        
         /* 헤더 */
        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #FFD200;
            letter-spacing: 2px;
            cursor: pointer;
            transition: color 0.3s;
            
        }
        .logo a{
        	text-decoration: none; color: inherit;
        }
        .logo:hover {
            color: #ff6b6b;
        }
        
        .nav-menu {
            display: flex;
            gap: 40px;
        }
        
        .nav-item {
            color: #666;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-item:hover {
            color: #ff6b6b;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn-login {
            background: #f1f3f4;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-login:hover {
            background: #ff6b6b;
        }
           
        .btn-signup {
            background: #FFD200;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-signup:hover {
            background: #ff5252;
        }

        .user-info {
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .welcome-text {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .btn-logout {
            background: #f1f3f4;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-logout:hover {
            background: #ff6b6b;
            color: white;
        }

        
        .main-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 70vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.5;
            animation: fadeIn 0.3s ease-out;
        }
        
        .chat-message.user {
            background-color: #FFD200;
            color: #333;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .chat-message.bot {
            background-color: #f1f3f4;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            position: relative;
        }

        .bot .message-title {
            font-weight: bold;
            color: #FFD200;
            margin-bottom: 5px;
        }
        
        .bot .message-content {
            font-size: 16px;
            line-height: 1.6;
        }
        
        .input-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message-input {
            flex-grow: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #FFD200;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #FFD200 0%, #ff8a80 100%);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 210, 0, 0.4);
        }
        
        .analyze-btn:disabled {
            background: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading-dots {
            width: 40px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .loading-dots div {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            animation: bounce 1s infinite ease-in-out;
        }

        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        .buttons-container {
		    display: flex;
		    gap: 10px; /* 버튼들 간의 간격을 조정 */
		    margin-bottom: 20px; /* 버튼 위쪽에 여백 추가 */
		    justify-content: center; /* 버튼들을 수평 중앙에 배치 */
		}
        
        .save-btn, .reset-btn {
            background: #f1f3f4;
            color: #666;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            margin-top: 20px;
            align-self: center;
        }
        
        .reset-btn:hover {
            background: #e8eaed;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 20px 15px;
                padding: 15px;
            }
            .page-title {
                font-size: 24px;
            }
            .page-subtitle {
                font-size: 14px;
            }
            .input-section {
                flex-direction: column;
                gap: 15px;
            }
            .analyze-btn {
                width: 100%;
                margin: 0;
            }
            .chat-message {
                max-width: 90%;
            }
        }
        .nav-item {
            color: #666;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            
        }
        
        .nav-item:hover {
            color: #ff6b6b;
        }
        
    </style>
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <div class="logo"><a href="main.html">TOKKI TALK</a></div>
            <nav class="nav-menu">
                <a href="intro.html" class="nav-item">소개</a>
                <a href="Question.html" class="nav-item" >대화하기</a>
                <a href="SenseTest.html" class="nav-item">센스고사</a>
                <a href="MyPage.html" class="nav-item">마이페이지</a>
            </nav>
            <div class="nav-buttons" id="auth-buttons">
                <button class="btn-login" onclick="window.location.href='main.html'">로그인</button>
                <button class="btn-signup" onclick="window.location.href='main.html'">회원가입</button>
            </div>
            <div class="user-info" id="user-info-area">
                <span class="welcome-text"><span id="headerUserName">사용자</span>님 환영합니다!</span>
                <button class="btn-logout" id="logoutBtn">로그아웃</button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <h1 class="page-title">💬 TOKKI에게 메시지 보내기</h1>
        <p class="page-subtitle">상대방의 메시지를 입력하면, TOKKI가 숨은 의미를 분석해드려요!</p>

        <div class="chat-area" id="chatArea">
            <div class="chat-message bot">
                <div class="message-title">TOKKI</div>
                <div class="message-content">
                    안녕하세요! 분석하고 싶은 메시지를 입력해주세요. 🐰<br>
                    <br>
                    **예시**<br>
                    "응... 좀 피곤해" 라고 입력해보세요.<br>
                    "오늘 저녁에 뭐 먹을까? 🍕" 라고 입력해보세요.<br>
                    "괜찮아, 신경 쓰지 마" 라고 입력해보세요.
                </div>
            </div>
        </div>

        <div class="input-section" id="inputSection">
            <textarea 
                class="message-input" 
                id="messageInput"
                placeholder="상대방의 메시지를 여기에 붙여넣어주세요."
                maxlength="500"
            ></textarea>
            <button class="analyze-btn" id="analyzeBtn">
                🔍 분석하기
            </button>
        </div>
        
        <div class="buttons-container">
        <button class="save-btn" id="saveBtn" onclick="saveAnalysis()">히스토리에 저장하기</button>
        <button class="reset-btn" id="resetBtn" onclick="resetAnalysis()">
            🔄 다시 분석하기
        </button>
        </div>
    </main>

    <script>
 // DOM 요소 가져오기
    const authButtons = document.getElementById('auth-buttons');
    const userInfoArea = document.getElementById('user-info-area');
    const headerUserName = document.getElementById('headerUserName');
    const logoutBtn = document.getElementById('logoutBtn');

    // 로그인 상태에 따라 헤더 UI를 업데이트하는 함수
    function updateHeaderUI() {
        const isLoggedIn = sessionStorage.getItem('loggedIn') === 'true';
        const userName = sessionStorage.getItem('userName');

        if (isLoggedIn && userName) {
            authButtons.style.display = 'none';
            userInfoArea.style.display = 'flex';
            headerUserName.textContent = userName;
        } else {
            authButtons.style.display = 'flex';
            userInfoArea.style.display = 'none';
        }
    }

    // 네비게이션 및 버튼 이벤트 리스너
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderUI();

        // 로그아웃 버튼 이벤트
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('loggedIn');
                sessionStorage.removeItem('userName');
                alert('로그아웃되었습니다.');
                window.location.href = 'main.html';
            });
        }

        // 네비게이션 링크 클릭 이벤트 (로그인 상태에 따라 이동 제어)
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', (e) => {
                const href = e.target.getAttribute('href');
                if (href === 'intro.html' || href === 'main.html') {
                    return; // 소개, 메인 페이지는 로그인 없이 이동 가능
                } else {
                    const isLoggedIn = sessionStorage.getItem('loggedIn') === 'true';
                    if (!isLoggedIn) {
                        e.preventDefault();
                        alert('로그인이 필요한 서비스입니다.');
                        window.location.href = 'main.html';
                    }
                }
            });
        });
    });
    
    
        const messageInput = document.getElementById('messageInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const chatArea = document.getElementById('chatArea');
        const resetBtn = document.getElementById('resetBtn');
        const inputSection = document.getElementById('inputSection');
        const saveBtn = document.getElementById('saveBtn');
        
        const ANALYSES = {
            "surface": "💬 표면적 의미",
            "hidden": "💡 숨은 의도",
            "emotion": "💖 감정 상태",
            "advice": "✍️ TOKKI의 제안"
        };

        // API 베이스 계산 (정적서버에서도 톰캣으로 폴백)
        function getApiBase() {
            const segs = window.location.pathname.split('/').filter(s => s.length > 0);
            if (segs.length > 0 && segs[0].indexOf('.') === -1) {
                return window.location.origin + '/' + segs[0];
            }
            const host = window.location.hostname;
            if (host === '127.0.0.1' || host === 'localhost') {
                return 'http://localhost:8081/TokkiTalk2';
            }
            return window.location.origin;
        }

        function simulateAnalysis(message) {
            let analysis = {
                surface: `상대방의 메시지는 **"${message}"** 라고 말하고 있어요.`,
                hidden: "분석 중...",
                emotion: "분석 중...",
                advice: "분석 중..."
            };

            // 예시 1: "응... 좀 피곤해"
            if (message.includes("피곤") && message.includes("...")) {
                analysis.hidden = "단순한 피곤함이 아니라, 당신과의 대화에 부담을 느끼거나 대화를 끝내고 싶어하는 의도가 숨어있을 수 있어요. '...'은 망설이거나 힘든 상황을 나타내요.";
                analysis.emotion = "상대방은 피로와 부담감을 느끼고 있어요. 당신의 질문에 솔직하게 답하기 어려운 상황일 수도 있습니다.";
                analysis.advice = "먼저 상대방을 배려하는 답변을 해보세요. '오늘은 푹 쉬고 내일 다시 얘기할까?'와 같이 상대방의 상황을 이해하고 배려하는 것이 중요해요. 👍";
            }
            // 예시 2: "오늘 저녁에 뭐 먹을까? 🍕"
            else if (message.includes("저녁") && message.includes("?")) {
                analysis.hidden = "상대방은 당신과 더 깊은 관계를 맺고 싶어하거나, 함께 시간을 보내고 싶어하는 의도를 보이고 있어요. '저녁'이라는 단어는 데이트 신청의 신호일 수 있습니다.";
                analysis.emotion = "기대감과 설렘을 느끼고 있어요. 당신의 답변을 기다리고 있습니다.";
                analysis.advice = "긍정적으로 화답해 보세요. '좋아! 뭐 먹고 싶은 거 있어?'와 같이 적극적으로 반응하면 상대방도 더 즐거워할 거예요. 💕";
            }
            // 예시 3: "괜찮아, 신경 쓰지 마"
            else if (message.includes("괜찮아") && message.includes("신경 쓰지 마")) {
                analysis.hidden = "상대방은 괜찮지 않을 가능성이 높아요. '신경 쓰지 마'는 오히려 당신의 관심과 위로를 바라는 반어법일 수 있어요.";
                analysis.emotion = "속상함, 서운함, 외로움 등의 감정을 숨기고 있어요. 당신이 자신의 마음을 알아주기를 기대하고 있습니다.";
                analysis.advice = "상대방의 말만 믿지 말고, 더 깊이 공감해주세요. '말은 그렇게 해도 괜찮지 않아 보이는데... 무슨 일 있었어?'와 같이 진심을 담아 물어보면 상대방도 마음을 열 거예요. 🥺";
            }
            // 기본 분석
            else {
                analysis.hidden = "메시지를 분석한 결과, 특별한 숨은 의도는 보이지 않아요. 상대방은 현재 대화에 대해 중립적인 반응을 보이고 있습니다.";
                analysis.emotion = "상대방은 중립적이고 편안한 감정을 느끼고 있어요. 대화에 부담을 느끼지 않고 편안하게 참여하고 있습니다.";
                analysis.advice = "자연스럽게 대화를 이어가세요. 상대방의 말에 공감하고, 더 깊은 대화를 유도하는 질문을 던져보세요! 👍";
            }

            return analysis;
        }

        // --- UI 및 이벤트 핸들링 ---
        
        analyzeBtn.addEventListener('click', async () => {
            const message = messageInput.value.trim();
            if (message.length > 0) {
                appendMessage(message, 'user');
                const loadingMessage = appendMessage('<div class="loading-dots"><div></div><div></div><div></div></div>', 'bot');

                messageInput.disabled = true;
                analyzeBtn.disabled = true;

                try {
                    const url = getApiBase() + '/analyze';
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input_type: 'text',
                            text: message,
                            options: { tone: '상큼' }
                        })
                    });

                    let analysis;
                    if (res.ok) {
                        const data = await res.json();
                        analysis = {
                            surface: (data.surface_meaning && data.surface_meaning.one_line) ? data.surface_meaning.one_line : `상대방의 메시지는 **"${message}"** 라고 말하고 있어요.`,
                            hidden: (data.hidden_meaning && data.hidden_meaning.one_line) ? data.hidden_meaning.one_line : '분석 중...',
                            emotion: (data.emotion && data.emotion.label) ? data.emotion.label : '분석 중...',
                            advice: (data.response_suggestion && data.response_suggestion.primary) ? data.response_suggestion.primary : '분석 중...'
                        };
                    } else {
                        analysis = simulateAnalysis(message);
                    }

                    chatArea.removeChild(loadingMessage);
                    const analysisKeys = Object.keys(analysis);
                    analysisKeys.forEach((key, index) => {
                        setTimeout(() => {
                            const title = ANALYSES[key];
                            appendMessage(`<b>${title}</b><br>${analysis[key]}`, 'bot');
                            if (index === analysisKeys.length - 1) {
                                inputSection.style.display = 'none';
                                saveBtn.style.display = 'block';
                                resetBtn.style.display = 'block';
                            }
                        }, 250 * (index));
                    });
                } catch (e) {
                    chatArea.removeChild(loadingMessage);
                    const analysis = simulateAnalysis(message);
                    Object.keys(analysis).forEach((key) => {
                        const title = ANALYSES[key];
                        appendMessage(`<b>${title}</b><br>${analysis[key]}`, 'bot');
                    });
                    inputSection.style.display = 'none';
                    saveBtn.style.display = 'block';
                    resetBtn.style.display = 'block';
                }
            }
        });
        
        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);
            messageElement.innerHTML = text;
            chatArea.appendChild(messageElement);
            chatArea.scrollTop = chatArea.scrollHeight;
            return messageElement;
        }

        function resetAnalysis() {
            messageInput.value = '';
            messageInput.disabled = false;
            analyzeBtn.disabled = false;
            
            chatArea.innerHTML = `
                <div class="chat-message bot">
                    <div class="message-title">TOKKI</div>
                    <div class="message-content">
                        안녕하세요! 분석하고 싶은 메시지를 입력해주세요. 🐰<br>
                        <br>
                        **예시**<br>
                        "응... 좀 피곤해" 라고 입력해보세요.<br>
                        "오늘 저녁에 뭐 먹을까? 🍕" 라고 입력해보세요.<br>
                        "괜찮아, 신경 쓰지 마" 라고 입력해보세요.
                    </div>
                </div>
            `;
            
            inputSection.style.display = 'flex';
            resetBtn.style.display = 'none';
            messageInput.focus();
        }
        
        function goHome() {
            if (confirm('홈 페이지로 돌아가시겠어요?')) {
                window.location.href = 'main.html';
            }
        }
        
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                analyzeBtn.click();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            messageInput.focus();
        });
    </script>
</body>
</html>