<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tokkitalk.db.AnalysisMapper">

  <insert id="insertAnalysis" parameterType="com.tokkitalk.analysis.store.AnalysisRecord">
    INSERT INTO ANALYSIS (
      ANALYSIS_ID,
      INPUT_TYPE,
      TEXT,
      IMAGE_URL,
      TONE,
      ANALYSIS_RESULT,
      SUGGESTIONS,
      USER_ID,
      CREATED_AT,
      UPDATED_AT
    ) VALUES (
      #{analysisId},
      #{inputType, jdbcType=VARCHAR},
      #{text, jdbcType=VARCHAR},
      #{imageUrl, jdbcType=VARCHAR},
      #{tone, jdbcType=VARCHAR},
      #{analysisResult, jdbcType=CLOB},
      #{suggestions,    jdbcType=CLOB},
      #{userId, jdbcType=NUMERIC},
      SYSTIMESTAMP,
      SYSTIMESTAMP
    )
  </insert>

  <select id="selectAnalysis" parameterType="string" resultType="com.tokkitalk.analysis.store.AnalysisRecord">
    SELECT
      ANALYSIS_ID   AS analysisId,
      INPUT_TYPE    AS inputType,
      TEXT          AS text,
      IMAGE_URL     AS imageUrl,
      TONE          AS tone,
      ANALYSIS_RESULT AS analysisResult,
      SUGGESTIONS     AS suggestions,
      USER_ID         AS userId
    FROM ANALYSIS
    WHERE ANALYSIS_ID = #{value}
  </select>

  <select id="selectByUser" parameterType="map" resultType="com.tokkitalk.analysis.store.AnalysisRecord">
    SELECT
      ANALYSIS_ID   AS analysisId,
      INPUT_TYPE    AS inputType,
      TEXT          AS text,
      IMAGE_URL     AS imageUrl,
      TONE          AS tone,
      ANALYSIS_RESULT AS analysisResult,
      SUGGESTIONS     AS suggestions,
      USER_ID         AS userId,
      CREATED_AT      AS createdAt
    FROM ANALYSIS
    WHERE USER_ID = #{userId}
    ORDER BY CREATED_AT DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- Feedback 저장 (스키마에 맞춤) -->
  <insert id="insertFeedback" parameterType="map">
    INSERT INTO ANALYSIS_FEEDBACK (
      FEEDBACK_ID, ANALYSIS_ID, LIKE_STATUS, PARTNER_REACTION, USER_COMMENT, CREATED_AT
    ) VALUES (
      ANALYSIS_FEEDBACK_SEQ.NEXTVAL, #{analysis_id}, #{liked}, #{partner_reaction}, #{user_comment, jdbcType=VARCHAR}, SYSTIMESTAMP
    )
  </insert>

  <delete id="deleteAnalysis" parameterType="string">
    DELETE FROM ANALYSIS WHERE ANALYSIS_ID = #{value}
  </delete>

  <!-- CHAT_HISTORY 저장 -->
  <insert id="insertChatHistory" parameterType="map">
    INSERT INTO CHAT_HISTORY (
      USER_ID,
      ROLE,
      MESSAGE_TEXT
    ) VALUES (
      #{userId},
      #{role},
      #{message}
    )
  </insert>

  <!-- CHAT_HISTORY 조회 -->
  <select id="selectChatHistory" parameterType="map" resultType="com.tokkitalk.analysis.GetHistoryServlet$HistoryItem">
    SELECT
      CHAT_ID AS id,
      USER_ID AS userId,
      ROLE AS role,
      MESSAGE_TEXT AS content,
      TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS createdAt
    FROM CHAT_HISTORY
    WHERE USER_ID = #{userId}
    ORDER BY CREATED_AT DESC
  </select>

</mapper>


