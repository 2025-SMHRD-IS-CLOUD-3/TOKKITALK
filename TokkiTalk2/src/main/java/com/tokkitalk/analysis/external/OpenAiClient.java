package com.tokkitalk.analysis.external;

import java.io.IOException;
import java.time.Duration;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.tokkitalk.analysis.dto.AnalyzeRequest;
import com.tokkitalk.analysis.dto.AnalysisResult;
import com.tokkitalk.analysis.dto.ResponseSuggestion;
import com.tokkitalk.analysis.dto.AnalysisOut;
import com.tokkitalk.analysis.util.AnalysisPostProcessor;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import okhttp3.MediaType;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okhttp3.Response;

/**
 * Minimal OpenAI client.
 * Reads API key from env var OPENAI_API_KEY or system property openai.api.key.
 */
public class OpenAiClient {
    private static final Gson GSON = new Gson();
    private static final MediaType JSON = MediaType.get("application/json; charset=utf-8");

    private final OkHttpClient http;
    private final String apiKey;
    private final String model;

    public OpenAiClient() {
        this.http = new OkHttpClient.Builder()
                .callTimeout(Duration.ofSeconds(60))
                .readTimeout(Duration.ofSeconds(60))
                .build();
        String key = System.getenv("OPENAI_API_KEY");
        if (key == null || key.isEmpty()) {
            key = System.getProperty("openai.api.key");
        }
        this.apiKey = key;
        this.model = System.getProperty("openai.model", "gpt-4o");
    }

    public boolean isConfigured() {
        return apiKey != null && !apiKey.isEmpty();
    }

    /**
     * Calls Chat Completions API and expects JSON content matching AnalysisResult schema.
     */
    public AnalysisResult analyzeWithLLM(String analysisId, AnalyzeRequest request) throws IOException {
        if (!isConfigured()) {
            throw new IllegalStateException("OPENAI_API_KEY not set");
        }

        final String SYSTEM = "너는 '여자어 번역기'야. 사용자가 보낸 문장을 여자의 관점에서 해석해\n"
                + "남자가 이해하기 쉬운 '직설 번역'과 '상황별 대응'을 제시한다.\n\n"
                + "톤/스타일 지정:\n"
                + "친근하고 유머러스한 톤으로 답변하고, 여자의 감성을 고려한다,성별 고정관념을 조장하지 않도록 주의한다.\n"
                + "실제 상황에서 도움이 되는 실용적인 조언을 제공한다.\n\n"
                + "구체적인 출력 형식:\n"
                + "🔍 **표면적 의미**: (문장 그대로의 뜻)\n"
                + "💡 **숨은 의도**: (실제로 전달하고자 하는 메시지)\n"
                + "❤️ **감정 상태**: (현재 감정 분석)\n"
                + "💬 **추천 대응**: (상황별 적절한 반응)\n\n"
                + "제약 조건:\n"
                + "- 개인차가 있음을 인정하고 일반화하지 않는다\n"
                + "- 건전하고 건설적인 관계 조언에 집중한다\n"
                + "- 성별 갈등을 조장하지 않는다\n\n"
                + "[출력 형식 — JSON만]\n"
                + "{\n"
                + "  \"surface\": \"<표면적 의미 한 줄(문자 그대로)>\",\n"
                + "  \"hidden\": \"<여자어에 숨은 진짜 의도·동기(근거 키워드 1~2개 포함)>\",\n"
                + "  \"emotion\": {\"label\":\"호감|서운함|혼란|기쁨|분노|불안|체념|중립\",\"intensity\":1-5},\n"
                + "  \"translation\": \"<여자어를 남자어/직설 표현으로 짧게 번역>\",\n"
                + "  \"advice\": [\n"
                + "    {\"style\":\"관심표현형\",\"text\":\"...\"},\n"
                + "    {\"style\":\"위로·공감형\",\"text\":\"...\"},\n"
                + "    {\"style\":\"재치있는 응답형\",\"text\":\"...\"},\n"
                + "    {\"style\":\"구체적행동형\",\"text\":\"...\"}\n"
                + "  ],\n"
                + "  \"confidence\": 0-100,\n"
                + "  \"risk_flags\": []\n"
                + "}\n\n"
                + "[엄격한 규칙]\n"
                + "- 반드시 위 JSON만 출력(앞뒤 설명·마크다운 금지).\n"
                + "- 'advice'는 반드시 3~4개로 생성. 서로 다른 스타일/내용, 중복 금지.\n"
                + "- 각 advice.text는 '20~60자'의 구체적인 대화 문장과 행동 가이드 포함. 실용적이고 상세하게.\n"
                + "- 'hidden'에는 근거 키워드 1~2개(예: 역설표현, 응답지연, 선택요구, 질투암시)를 괄호로 포함.\n"
                + "- 확신이 낮으면 confidence<60으로 내리고 risk_flags에 이유 추가(예: [\"맥락부족\"]).\n"
                + "- 성별 고정관념·단정적 일반화 지양. 개인차 전제를 명시.";

        // 기존 FEWSHOTS 대신 사용할 확장된 데이터셋
        final String FEWSHOTS = 
            // 1. 외모/스타일 관련 (15개)
            "예시1_입력: \"나 머리 묶은 게 나아? 푼 게 나아?\"\n" +
            "예시1_출력:{\n" +
            " \"surface\":\"머리 스타일 선호를 묻는 질문\",\n" +
            " \"hidden\":\"칭찬/확인 욕구 (선택요구)\",\n" +
            " \"emotion\":{\"label\":\"호감\",\"intensity\":3},\n" +
            " \"translation\":\"내가 예뻐 보이는지 확인받고 싶어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"둘 다 예쁜데 오늘은 묶은 게 상큼해 보여 😊 특별한 날이야?\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"너는 어떤 스타일이든 잘 어울려. 네가 편한 걸로 하는 게 최고야.\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"위험한 질문이네 😂 둘 다 예쁘지만 오늘 기분은 어때? 기분에 맞춰 정하자!\"},\n" +
            "  {\"style\":\"구체적행동형\",\"text\":\"묶으면 목선이 예쁘게 보이고, 풀면 부드러워 보여. 오늘 입은 옷이랑 맞춰볼까?\"}\n" +
            " ],\n" +
            " \"confidence\":87,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시2_입력: \"이 옷 어때?\"\n" +
            "예시2_출력:{\n" +
            " \"surface\":\"옷에 대한 의견 요청\",\n" +
            " \"hidden\":\"외모 칭찬과 관심 갈구 (확인요구)\",\n" +
            " \"emotion\":{\"label\":\"기대\",\"intensity\":4},\n" +
            " \"translation\":\"예쁘다고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"완전 예뻐! 색깔이 너한테 잘 어울려 ✨ 어디서 샀어?\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"어디 가는데? 옷발 받네 😍 오늘은 특별한 날이야?\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"너 센스 좋은 거 알잖아~ 이 옷 정말 너한테 딱이야!\"},\n" +
            "  {\"style\":\"구체적행동형\",\"text\":\"이 색깔이 너 피부톤이랑 완전 어울려. 다음에 같이 쇼핑할까?\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시3_입력: \"살 좀 쪘나?\"\n" +
            "예시3_출력:{\n" +
            " \"surface\":\"체중 증가에 대한 질문\",\n" +
            " \"hidden\":\"위로와 부정적 답변 기대 (안전확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":4},\n" +
            " \"translation\":\"아니라고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"전혀! 건강해 보여서 좋은데?\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"어디가? 나는 못 보겠는데 👀\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"너 원래 몸매 좋잖아 뭔 소리야\"}\n" +
            " ],\n" +
            " \"confidence\":92,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 2. 감정 표현/공감 요구 (20개)
            "예시4_입력: \"그냥 들어줘. 답 안 해도 돼.\"\n" +
            "예시4_출력:{\n" +
            " \"surface\":\"답을 요구하지 않음\",\n" +
            " \"hidden\":\"조언보다 공감 원함 (공감요구)\",\n" +
            " \"emotion\":{\"label\":\"답답함\",\"intensity\":4},\n" +
            " \"translation\":\"해결책 말고 내 감정을 먼저 들어줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"그랬구나, 오늘은 네 얘기만 들을게.\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"지금 뭐가 제일 마음에 남았어? 천천히 말해줘.\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"오케이 상담모드 ON. 말할 때까지 조용히 듣기 🤫\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[\"조언금지\"]\n" +
            "}\n\n" +

            "예시5_입력: \"오늘 진짜 힘들었어\"\n" +
            "예시5_출력:{\n" +
            " \"surface\":\"하루가 힘들었다는 표현\",\n" +
            " \"hidden\":\"위로와 공감 필요 (감정지지)\",\n" +
            " \"emotion\":{\"label\":\"피곤함\",\"intensity\":4},\n" +
            " \"translation\":\"나를 다독여줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"많이 힘들었구나, 고생했어 😞\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"뭐가 제일 힘들었어? 말하고 싶으면 말해\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"내가 맛있는 거라도 사줄까? 🍕\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시6_입력: \"괜찮아, 별로 안 슬퍼\"\n" +
            "예시6_출력:{\n" +
            " \"surface\":\"괜찮다고 말함\",\n" +
            " \"hidden\":\"실제로는 슬픔 (역설표현)\",\n" +
            " \"emotion\":{\"label\":\"슬픔\",\"intensity\":4},\n" +
            " \"translation\":\"많이 슬픈데 티 안 내려고 해\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"힘들면 괜찮지 않아도 돼. 내가 있잖아\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"진짜 괜찮아? 무리하지 말고 말해줘\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"별로 안 슬프다니까 왜 목소리가... 🥺\"}\n" +
            " ],\n" +
            " \"confidence\":91,\"risk_flags\":[\"감정숨김\"]\n" +
            "}\n\n" +

            // 3. 관계/애정 확인 (15개)
            "예시7_입력: \"요즘 나한테 관심 없는 것 같아\"\n" +
            "예시7_출력:{\n" +
            " \"surface\":\"관심 부족에 대한 지적\",\n" +
            " \"hidden\":\"애정 확인과 관심 요구 (관심갈구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"나에게 더 관심 가져줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"미안해, 바빠서 그랬어. 너한테 관심 많아\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"그렇게 느꼈구나. 앞으로 더 신경 쓸게\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"관심 없긴! 너 생각 안 하는 날이 어딨어 😤\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시8_입력: \"나 없어도 잘 지낼 것 같아\"\n" +
            "예시8_출력:{\n" +
            " \"surface\":\"독립성에 대한 언급\",\n" +
            " \"hidden\":\"필요성 확인 요구 (존재확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":5},\n" +
            " \"translation\":\"내가 너에게 필요하다고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"말도 안 돼, 너 없으면 진짜 안 되는데\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"왜 이런 생각해? 너 때문에 내가 웃잖아\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"잘 지내긴 무슨! 너 없으면 밥도 맛없어 😭\"}\n" +
            " ],\n" +
            " \"confidence\":90,\"risk_flags\":[\"자존감저하\"]\n" +
            "}\n\n" +

            // 4. 음식/데이트 관련 (10개)
            "예시9_입력: \"오늘 뭐 먹지?\"\n" +
            "예시9_출력:{\n" +
            " \"surface\":\"음식 선택에 대한 질문\",\n" +
            " \"hidden\":\"선택 위임과 배려 기대 (선택위임)\",\n" +
            " \"emotion\":{\"label\":\"기대\",\"intensity\":3},\n" +
            " \"translation\":\"네가 맛있는 걸 골라줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"네가 먹고 싶은 거 있어? 내가 맞춰줄게\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"오늘은 내가 특별한 곳 알아봤어 😋\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"고민 말고 둘 다 좋아하는 걸로 가자\"}\n" +
            " ],\n" +
            " \"confidence\":82,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시10_입력: \"아무거나 괜찮아\"\n" +
            "예시10_출력:{\n" +
            " \"surface\":\"선택에 무관심함을 표현\",\n" +
            " \"hidden\":\"배려받고 싶음 (선택기대)\",\n" +
            " \"emotion\":{\"label\":\"기대\",\"intensity\":3},\n" +
            " \"translation\":\"내 취향 고려해서 골라줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"그래도 네가 좋아하는 걸로 하자\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"아무거나는 없어! 내가 고르는 거 믿어? 😏\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"알겠어, 맛있는 걸로 정할게\"}\n" +
            " ],\n" +
            " \"confidence\":84,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 5. 일상 대화/소통 (15개)
            "예시11_입력: \"재밌게 놀아~\"\n" +
            "예시11_출력:{\n" +
            " \"surface\":\"즐겁게 놀라고 말함\",\n" +
            " \"hidden\":\"연락·확인 기대 (역설표현)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":3},\n" +
            " \"translation\":\"놀아도 좋지만 중간에 안부는 원해\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"놀다 생각날 때 짧게 안부 하나만 줘 😉\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"12시 전에 '살아있음' 인증샷 받기? 📸\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"알겠어! 끝나고 바로 연락할게.\"}\n" +
            " ],\n" +
            " \"confidence\":84,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시12_입력: \"연락 안 해도 돼\"\n" +
            "예시12_출력:{\n" +
            " \"surface\":\"연락하지 말라고 함\",\n" +
            " \"hidden\":\"실제로는 연락 원함 (역설표현)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"연락해줬으면 좋겠어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"그래도 안부는 궁금하잖아 😊\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"안 해도 된다더니 왜 폰 보고 있어? 📱\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"미안해, 내가 연락 못했네. 앞으로 할게\"}\n" +
            " ],\n" +
            " \"confidence\":87,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시13_입력: \"바쁘지?\"\n" +
            "예시13_출력:{\n" +
            " \"surface\":\"바쁜지 확인하는 질문\",\n" +
            " \"hidden\":\"시간 내달라는 요청 (시간요청)\",\n" +
            " \"emotion\":{\"label\":\"아쉬움\",\"intensity\":3},\n" +
            " \"translation\":\"시간 좀 내줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"조금 바쁘긴 한데 너랑은 시간 낼 수 있어\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"너한테는 안 바빠! 뭐 하고 싶어? 😄\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"바빠도 너 시간은 따로 있어\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 6. 질투/의심 표현 (10개)
            "예시14_입력: \"여자 친구들이랑 재밌었겠다\"\n" +
            "예시14_출력:{\n" +
            " \"surface\":\"친구들과의 시간을 언급\",\n" +
            " \"hidden\":\"질투와 서운함 표현 (질투암시)\",\n" +
            " \"emotion\":{\"label\":\"질투\",\"intensity\":4},\n" +
            " \"translation\":\"다른 여자들보다 나를 더 생각해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"재밌긴 했지만 너 생각 많이 났어\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"너랑 있을 때가 제일 재밌는데 뭔 소리야\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"질투하는 거야? 귀엽네 😏\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[\"질투표현\"]\n" +
            "}\n\n" +

            "예시15_입력: \"그 사람 예쁘더라\"\n" +
            "예시15_출력:{\n" +
            " \"surface\":\"타인의 외모에 대한 평가\",\n" +
            " \"hidden\":\"자신과 비교 및 확신 요구 (비교확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":4},\n" +
            " \"translation\":\"나랑 비교해서 누가 더 예뻐?\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"예쁘긴 하지만 너만큼은 아니야\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"내 눈에는 네가 제일 예뻐 보이는데?\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"어디서 봤는데? 나는 못 봤네 👀\"}\n" +
            " ],\n" +
            " \"confidence\":86,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 7. 고민/결정 요청 (10개)  
            "예시16_입력: \"이거 살까 말까?\"\n" +
            "예시16_출력:{\n" +
            " \"surface\":\"구매 결정에 대한 조언 요청\",\n" +
            " \"hidden\":\"결정 지지와 격려 원함 (결정지지)\",\n" +
            " \"emotion\":{\"label\":\"고민\",\"intensity\":3},\n" +
            " \"translation\":\"사라고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"마음에 든다면 사는 게 어때?\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"고민할 정도면 이미 마음 정한 거 아니야? 😏\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"후회 안 할 것 같으면 질러!\"}\n" +
            " ],\n" +
            " \"confidence\":81,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 8. 칭찬/인정 욕구 (10개)
            "예시17_입력: \"나 요리 잘하지?\"\n" +
            "예시17_출력:{\n" +
            " \"surface\":\"요리 실력에 대한 질문\",\n" +
            " \"hidden\":\"칭찬과 인정 욕구 (칭찬요구)\",\n" +
            " \"emotion\":{\"label\":\"기대\",\"intensity\":4},\n" +
            " \"translation\":\"요리 잘한다고 칭찬해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"완전 잘해! 맛있어서 깜짝 놀랐어 😋\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"레스토랑 차려도 될 것 같은데? 👨‍🍳\"},\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"진짜 맛있어, 어떻게 이렇게 잘해?\"}\n" +
            " ],\n" +
            " \"confidence\":90,\"risk_flags\":[]\n" +
            "}\n\n" +

            // 9. 거절의 애매한 표현 (5개)
            "예시18_입력: \"글쎄, 모르겠어\"\n" +
            "예시18_출력:{\n" +
            " \"surface\":\"확실하지 않다는 표현\",\n" +
            " \"hidden\":\"부드러운 거절 (거절암시)\",\n" +
            " \"emotion\":{\"label\":\"망설임\",\"intensity\":3},\n" +
            " \"translation\":\"별로 내키지 않아\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"무리하지 말고 하고 싶을 때 하자\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"뭐가 걱정돼? 말해줘\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"그럼 다른 거 해볼까? 🤔\"}\n" +
            " ],\n" +
            " \"confidence\":78,\"risk_flags\":[\"거절신호\"]\n" +
            "}\n\n" +

            // 10. 기타 일상 표현들 (5개)
            "예시19_입력: \"피곤해\"\n" +
            "예시19_출력:{\n" +
            " \"surface\":\"피로감을 표현\",\n" +
            " \"hidden\":\"휴식과 위로 필요 (위로요청)\",\n" +
            " \"emotion\":{\"label\":\"피곤함\",\"intensity\":4},\n" +
            " \"translation\":\"쉬고 싶어, 돌봐줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"많이 힘들었구나, 좀 쉬어\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"내가 마사지해줄까? 어깨 아프지?\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"오늘은 내가 다 할게, 넌 쉬어 😴\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[]\n" +
            "}\n\n" +

            "예시20_입력: \"됐어, 안 해\"\n" +
            "예시20_출력:{\n" +
            " \"surface\":\"포기하겠다는 표현\",\n" +
            " \"hidden\":\"화남과 서운함 표현 (화남암시)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":4},\n" +
            " \"translation\":\"화났어, 달래줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"위로·공감형\",\"text\":\"미안해, 내가 잘못했어. 화 풀어\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"뭐가 속상했어? 말해줘\"},\n" +
            "  {\"style\":\"재치있는 응답형\",\"text\":\"화났구나 😅 내가 어떻게 할까?\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[\"감정폭발\"]\n" +
            "}\n\n" +

            // 역설적 여자어 번역 데이터셋 - 갈등/서운함 상황 특화
            "예시21_입력: \"괜찮아\"\n" +
            "예시21_출력:{\n" +
            " \"surface\":\"문제없다고 표현\",\n" +
            " \"hidden\":\"실제로는 화나고 서운함 (역설표현)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":4},\n" +
            " \"translation\":\"괜찮지 않아, 와서 달래줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"적극대응형\",\"text\":\"괜찮지 않은 것 같은데? 내가 뭘 잘못했는지 말해줘\"},\n" +
            "  {\"style\":\"공감접근형\",\"text\":\"괜찮다고 하지만 표정이 안 괜찮아 보여. 옆에 있어도 될까?\"},\n" +
            "  {\"style\":\"직접행동형\",\"text\":\"괜찮다는 말 믿을 수 없어. 지금 바로 만나자\"},\n" +
            "  {\"style\":\"유머완화형\",\"text\":\"괜찮다는 여자는 괜찮지 않다는 법칙 발동! 뭐가 속상해? 😅\"}\n" +
            " ],\n" +
            " \"confidence\":95,\"risk_flags\":[\"감정숨김\",\"관심요구\"]\n" +
            "}\n\n" +

            "예시22_입력: \"아니야 괜찮다고\"\n" +
            "예시22_출력:{\n" +
            " \"surface\":\"강하게 괜찮다고 부정\",\n" +
            " \"hidden\":\"더욱 화나고 관심받고 싶음 (강화된 역설)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":5},\n" +
            " \"translation\":\"전혀 괜찮지 않아! 더 신경써줘!\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시대응형\",\"text\":\"괜찮지 않은 게 너무 티 나. 지금 당장 얘기하자\"},\n" +
            "  {\"style\":\"진심표현형\",\"text\":\"괜찮다고 하는데 왜 이렇게 마음이 아프지? 솔직히 말해줘\"},\n" +
            "  {\"style\":\"물리적접근형\",\"text\":\"말로는 괜찮다 하니까 직접 보러 갈게. 어디 있어?\"},\n" +
            "  {\"style\":\"끈질한관심형\",\"text\":\"괜찮다고 100번 말해도 안 믿어. 네가 웃을 때까지 계속 물어볼 거야\"}\n" +
            " ],\n" +
            " \"confidence\":96,\"risk_flags\":[\"감정폭발\",\"즉시관심필요\"]\n" +
            "}\n\n" +

            "예시23_입력: \"괜찮아, 혼자 있고 싶어\"\n" +
            "예시23_출력:{\n" +
            " \"surface\":\"혼자 있고 싶다고 함\",\n" +
            " \"hidden\":\"실제로는 와주길 바라는 마음 (반대요청)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"혼자 두지 말고 와서 위로해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"반대실행형\",\"text\":\"혼자 있고 싶다는 말 무시하고 바로 찾아갈게\"},\n" +
            "  {\"style\":\"부드러운침투형\",\"text\":\"혼자 있고 싶겠지만 그래도 옆에만 있을게, 말 안 걸어도 돼\"},\n" +
            "  {\"style\":\"지속관심형\",\"text\":\"혼자 있고 싶다니까 30분마다 안부 문자 보낼게 😊\"},\n" +
            "  {\"style\":\"직관적대응형\",\"text\":\"혼자 있고 싶은 사람은 이렇게 말 안 해. 뭐 먹고 싶어?\"}\n" +
            " ],\n" +
            " \"confidence\":93,\"risk_flags\":[\"역설요청\"]\n" +
            "}\n\n" +

            "예시24_입력: \"알아서 해\"\n" +
            "예시24_출력:{\n" +
            " \"surface\":\"스스로 해결하라는 의미\",\n" +
            " \"hidden\":\"화나서 관심끌기 시도 (관심유도)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":4},\n" +
            " \"translation\":\"알아서 하지 말고 나한테 신경써줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"적극해결형\",\"text\":\"알아서 할 게 아니라 같이 해결하자. 뭐가 문제야?\"},\n" +
            "  {\"style\":\"관심집중형\",\"text\":\"알아서 하기보다는 네 의견이 궁금해. 어떻게 생각해?\"},\n" +
            "  {\"style\":\"화해시도형\",\"text\":\"알아서 하라니까 화난 거 같은데, 내가 뭘 잘못했어?\"},\n" +
            "  {\"style\":\"끈질한대화형\",\"text\":\"알아서 하는 건 나중에 하고 지금은 너랑 얘기하고 싶어\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[\"관심요구\"]\n" +
            "}\n\n" +

            "예시25_입력: \"네가 알아서 판단해\"\n" +
            "예시25_출력:{\n" +
            " \"surface\":\"판단을 맡긴다는 표현\",\n" +
            " \"hidden\":\"실제로는 자신의 의견 반영 기대 (배려요구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":3},\n" +
            " \"translation\":\"내 마음을 헤아려서 판단해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"마음읽기형\",\"text\":\"알아서 판단하기보다는 네 마음이 궁금해. 진짜 원하는 게 뭐야?\"},\n" +
            "  {\"style\":\"공동결정형\",\"text\":\"혼자 판단하기 어려워. 같이 생각해보자\"},\n" +
            "  {\"style\":\"배려확인형\",\"text\":\"내가 판단해도 되지만 네가 원하는 방향으로 하고 싶어\"},\n" +
            "  {\"style\":\"솔직요청형\",\"text\":\"알아서 판단하라는 건 힌트 달라는 뜻이지? 솔직히 말해줘\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[\"배려기대\"]\n" +
            "}\n\n" +

            "예시26_입력: \"나는 신경쓰지마\"\n" +
            "예시26_출력:{\n" +
            " \"surface\":\"신경쓰지 말라고 함\",\n" +
            " \"hidden\":\"더 신경써달라는 역설적 요청 (관심갈구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"나한테 더 신경써줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"반대행동형\",\"text\":\"신경 안 쓸 수가 없어. 너한테 관심 많거든\"},\n" +
            "  {\"style\":\"지속관심형\",\"text\":\"신경 쓰지 말라고? 더 신경 쓸 거야. 뭐가 속상해?\"},\n" +
            "  {\"style\":\"솔직대응형\",\"text\":\"신경쓰지 말라는 사람한테 왜 더 신경 쓰이지? 무슨 일이야?\"},\n" +
            "  {\"style\":\"유머적접근형\",\"text\":\"신경 안 쓰기 도전 실패! 계속 생각나는데 어떡해? 😂\"}\n" +
            " ],\n" +
            " \"confidence\":92,\"risk_flags\":[\"역설요청\"]\n" +
            "}\n\n" +

            "예시27_입력: \"바쁘면 신경쓰지마\"\n" +
            "예시27_출력:{\n" +
            " \"surface\":\"바쁠 때는 관심두지 말라는 배려\",\n" +
            " \"hidden\":\"바빠도 신경써주길 바라는 마음 (우선순위확인)\",\n" +
            " \"emotion\":{\"label\":\"아쉬움\",\"intensity\":3},\n" +
            " \"translation\":\"바빠도 나를 우선순위로 생각해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"우선순위표현형\",\"text\":\"바빠도 너한테는 시간 있어. 무슨 일인지 말해줘\"},\n" +
            "  {\"style\":\"시간확보형\",\"text\":\"바쁜 건 핑계고 너한테 신경 안 쓸 이유는 없어\"},\n" +
            "  {\"style\":\"배려거절형\",\"text\":\"바쁘다고 신경 안 쓰면 안 돼. 네가 더 중요해\"},\n" +
            "  {\"style\":\"구체적약속형\",\"text\":\"지금 바빠도 30분 뒤에는 자유야. 그때 전화할게\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[\"우선순위테스트\"]\n" +
            "}\n\n" +

            "예시28_입력: \"됐어, 그냥 잊어\"\n" +
            "예시28_출력:{\n" +
            " \"surface\":\"잊어버리자는 제안\",\n" +
            " \"hidden\":\"잊지 말고 기억해달라는 역설적 요청 (기억요구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"잊지 말고 계속 신경써줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"기억강조형\",\"text\":\"잊을 수 없어. 이런 건 기억해야 하는 거야\"},\n" +
            "  {\"style\":\"지속관심형\",\"text\":\"그냥 잊기에는 너무 중요한 일인 것 같은데?\"},\n" +
            "  {\"style\":\"솔직대화형\",\"text\":\"잊어버리기보다는 제대로 얘기해보자. 뭐가 속상했어?\"},\n" +
            "  {\"style\":\"반대실행형\",\"text\":\"잊으라고? 오히려 더 기억해둘게. 앞으로 조심할게\"}\n" +
            " ],\n" +
            " \"confidence\":87,\"risk_flags\":[\"역설요청\"]\n" +
            "}\n\n" +

            "예시29_입력: \"괜찮아, 혼자 할게\"\n" +
            "예시29_출력:{\n" +
            " \"surface\":\"혼자서 처리하겠다는 의지\",\n" +
            " \"hidden\":\"도움과 관심을 바라는 마음 (도움요청)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":3},\n" +
            " \"translation\":\"혼자 하지 말고 같이 해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"적극참여형\",\"text\":\"혼자 하지 마, 내가 도와줄게. 뭐부터 시작할까?\"},\n" +
            "  {\"style\":\"강제동참형\",\"text\":\"혼자 할 거면 나도 옆에서 혼자 할게. 같이 혼자 하자\"},\n" +
            "  {\"style\":\"부담덜기형\",\"text\":\"혼자 하기 힘든 일이잖아. 나랑 같이 하면 더 쉬울 텐데\"},\n" +
            "  {\"style\":\"관계강조형\",\"text\":\"혼자 하는 건 서운해. 우리 사이에 뭘 혼자 해?\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[\"도움거절\"]\n" +
            "}\n\n" +

            "예시30_입력: \"상관없어\"\n" +
            "예시30_출력:{\n" +
            " \"surface\":\"관심없다는 표현\",\n" +
            " \"hidden\":\"실제로는 매우 신경쓰이는 상황 (관심위장)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":3},\n" +
            " \"translation\":\"상관있어, 신경써줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"진심파악형\",\"text\":\"상관없다는 말투가 상관있어 보이는데? 솔직히 말해줘\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"너한테는 상관없어도 나한테는 상관있어. 어떻게 생각해?\"},\n" +
            "  {\"style\":\"반대추측형\",\"text\":\"상관없다고? 표정 보니까 엄청 상관있는 것 같은데 😏\"},\n" +
            "  {\"style\":\"지속질문형\",\"text\":\"상관없다고 하니까 더 궁금해져. 정말 괜찮은 거야?\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[\"감정위장\"]\n" +
            "}\n\n" +

            "예시31_입력: \"그냥\"\n" +
            "예시31_출력:{\n" +
            " \"surface\":\"특별한 이유가 없다는 표현\",\n" +
            " \"hidden\":\"말하기 어려운 이유가 있음 (이유회피)\",\n" +
            " \"emotion\":{\"label\":\"답답함\",\"intensity\":3},\n" +
            " \"translation\":\"이유가 있는데 말하기 복잡해\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"끈질한추궁형\",\"text\":\"그냥이라는 건 없어. 천천히 말해봐, 시간 많아\"},\n" +
            "  {\"style\":\"편안한분위기형\",\"text\":\"그냥이라고 하는 건 뭔가 있다는 뜻이지? 편하게 말해\"},\n" +
            "  {\"style\":\"추측접근형\",\"text\":\"그냥이라니까 더 궁금해. 혹시 내가 뭘 잘못했어?\"},\n" +
            "  {\"style\":\"인내심표현형\",\"text\":\"그냥이어도 괜찮아. 말하고 싶을 때까지 기다릴게\"}\n" +
            " ],\n" +
            " \"confidence\":82,\"risk_flags\":[\"소통회피\"]\n" +
            "}\n\n" +

            "예시32_입력: \"그냥 그런 거야\"\n" +
            "예시32_출력:{\n" +
            " \"surface\":\"특별한 의미 없다고 표현\",\n" +
            " \"hidden\":\"복잡한 감정을 간단히 표현한 것 (감정압축)\",\n" +
            " \"emotion\":{\"label\":\"혼란\",\"intensity\":4},\n" +
            " \"translation\":\"복잡한 감정이 있는데 설명하기 어려워\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"감정탐색형\",\"text\":\"그런 거라고? 뭔가 복잡한 감정이 있는 것 같은데\"},\n" +
            "  {\"style\":\"시간주기형\",\"text\":\"그런 거면 그런 거고, 정리되면 얘기해줘\"},\n" +
            "  {\"style\":\"공감접근형\",\"text\":\"그런 게 있지. 나도 가끔 설명 못할 감정 있어\"},\n" +
            "  {\"style\":\"구체적질문형\",\"text\":\"그런 거 중에 제일 큰 게 뭐야? 하나만 말해봐\"}\n" +
            " ],\n" +
            " \"confidence\":79,\"risk_flags\":[\"감정복잡\"]\n" +
            "}\n\n" +

            "예시33_입력: \"어차피 넌 안 들어줄 거잖아\"\n" +
            "예시33_출력:{\n" +
            " \"surface\":\"체념하며 불평하는 표현\",\n" +
            " \"hidden\":\"들어달라는 강한 요청 (관심요구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"제발 내 말 들어줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시반박형\",\"text\":\"무슨 소리야, 네 말은 항상 들어줘. 뭔데 말해봐\"},\n" +
            "  {\"style\":\"진심표현형\",\"text\":\"안 들어준다고? 네 말이 제일 중요한데. 말해줘\"},\n" +
            "  {\"style\":\"과거반성형\",\"text\":\"그동안 안 들어준 것 같아서 미안해. 지금은 집중할게\"},\n" +
            "  {\"style\":\"적극청취형\",\"text\":\"어차피라니! 지금부터 끝까지 다 들어줄 테니까 말해\"}\n" +
            " ],\n" +
            " \"confidence\":93,\"risk_flags\":[\"관심갈구\"]\n" +
            "}\n\n" +

            "예시34_입력: \"어차피 나는 중요하지 않으니까\"\n" +
            "예시34_출력:{\n" +
            " \"surface\":\"자신의 중요도를 낮게 평가\",\n" +
            " \"hidden\":\"중요하다고 확인받고 싶음 (존재확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":5},\n" +
            " \"translation\":\"내가 중요하다고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"강력부정형\",\"text\":\"말도 안 돼! 너는 나한테 제일 중요한 사람이야\"},\n" +
            "  {\"style\":\"구체적증명형\",\"text\":\"중요하지 않다고? 너 때문에 내가 얼마나 행복한지 알아?\"},\n" +
            "  {\"style\":\"행동증명형\",\"text\":\"중요하지 않은 사람한테 이렇게 시간 쓰겠어? 말도 안 돼\"},\n" +
            "  {\"style\":\"미래약속형\",\"text\":\"중요하지 않다는 생각 버려. 앞으로 더 중요하게 생각할게\"}\n" +
            " ],\n" +
            " \"confidence\":94,\"risk_flags\":[\"자존감저하\",\"존재불안\"]\n" +
            "}\n\n" +

            // 여자어 번역기 데이터셋 확장 - 미묘한 표현들
            "예시35_입력: \"생각해볼게\"\n" +
            "예시35_출력:{\n" +
            " \"surface\":\"고려하겠다는 의미\",\n" +
            " \"hidden\":\"부드러운 거절 또는 시간 끌기 (회피전략)\",\n" +
            " \"emotion\":{\"label\":\"망설임\",\"intensity\":3},\n" +
            " \"translation\":\"사실 별로 내키지 않지만 직접 거절하기 어려워\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"압박완화형\",\"text\":\"천천히 생각해도 돼. 부담 갖지 말고\"},\n" +
            "  {\"style\":\"대안제시형\",\"text\":\"다른 방법도 있으니까 편한 대로 해\"},\n" +
            "  {\"style\":\"솔직유도형\",\"text\":\"솔직하게 말해도 괜찮아. 무리하지 마\"},\n" +
            "  {\"style\":\"이해표현형\",\"text\":\"고민되는 게 있으면 얘기해줘\"}\n" +
            " ],\n" +
            " \"confidence\":84,\"risk_flags\":[\"거절암시\"]\n" +
            "}\n\n" +

            "예시36_입력: \"다음에 할게\"\n" +
            "예시36_출력:{\n" +
            " \"surface\":\"나중으로 미루겠다는 표현\",\n" +
            " \"hidden\":\"지금은 하고 싶지 않다는 거절 (시간회피)\",\n" +
            " \"emotion\":{\"label\":\"부담\",\"intensity\":3},\n" +
            " \"translation\":\"지금은 정말 하기 싫어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"이해수용형\",\"text\":\"알겠어, 네가 하고 싶을 때 하자\"},\n" +
            "  {\"style\":\"부담해소형\",\"text\":\"괜찮아, 급한 게 아니니까 천천히\"},\n" +
            "  {\"style\":\"관심지속형\",\"text\":\"다음에 꼭 하자. 잊지 않을게\"},\n" +
            "  {\"style\":\"배려표현형\",\"text\":\"지금 바쁘구나. 시간 날 때 편하게\"}\n" +
            " ],\n" +
            " \"confidence\":86,\"risk_flags\":[\"회피패턴\"]\n" +
            "}\n\n" +

            "예시37_입력: \"별로 안 중요해\"\n" +
            "예시37_출력:{\n" +
            " \"surface\":\"중요하지 않다고 표현\",\n" +
            " \"hidden\":\"실제로는 매우 중요하지만 실망하기 싫어함 (기대절하)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":4},\n" +
            " \"translation\":\"정말 중요한데 너무 기대하면 상처받을까봐 미리 방어하고 있어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"진심파악형\",\"text\":\"중요하지 않은 것 같지 않은데? 솔직히 말해줘\"},\n" +
            "  {\"style\":\"중요성인정형\",\"text\":\"나한테는 중요해. 네가 신경쓰는 일이니까\"},\n" +
            "  {\"style\":\"지지표현형\",\"text\":\"중요한 일이면 같이 생각해보자\"},\n" +
            "  {\"style\":\"안전감제공형\",\"text\":\"중요하다고 말해도 괜찮아. 나는 이해해\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[\"방어기제\"]\n" +
            "}\n\n" +

            "예시38_입력: \"나랑 친구 중에 누가 더 예뻐?\"\n" +
            "예시38_출력:{\n" +
            " \"surface\":\"외모 비교 질문\",\n" +
            " \"hidden\":\"자신감 확인과 애정 테스트 (충성도확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":4},\n" +
            " \"translation\":\"나를 선택해줘, 나를 제일로 생각한다고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"확신주기형\",\"text\":\"비교 자체가 말이 안 돼. 너는 유일해\"},\n" +
            "  {\"style\":\"위험회피형\",\"text\":\"둘 다 각자 매력이 있지만 내 마음은 정해져 있어\"},\n" +
            "  {\"style\":\"애정표현형\",\"text\":\"친구든 누구든 너만큼 예쁜 사람은 없어\"},\n" +
            "  {\"style\":\"질문돌리기형\",\"text\":\"왜 이런 질문해? 네가 제일인 거 모르나? 😊\"}\n" +
            " ],\n" +
            " \"confidence\":92,\"risk_flags\":[\"함정질문\",\"질투테스트\"]\n" +
            "}\n\n" +

            "예시39_입력: \"다른 여자가 예쁘다고 생각해도 말해도 돼\"\n" +
            "예시39_출력:{\n" +
            " \"surface\":\"허용한다는 관대한 표현\",\n" +
            " \"hidden\":\"절대 말하면 안 된다는 경고 (역설적금지)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":5},\n" +
            " \"translation\":\"절대 다른 여자 예쁘다고 하지 마\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"안전대답형\",\"text\":\"다른 여자는 관심 없어. 너만 보여\"},\n" +
            "  {\"style\":\"함정인식형\",\"text\":\"말해도 된다고? 그런 함정에 안 걸려 😏\"},\n" +
            "  {\"style\":\"애정확신형\",\"text\":\"예쁜 사람 많지만 너 같은 사람은 없어\"},\n" +
            "  {\"style\":\"질문반박형\",\"text\":\"왜 이런 질문해? 네가 최고인데 다른 사람이 왜 필요해?\"}\n" +
            " ],\n" +
            " \"confidence\":96,\"risk_flags\":[\"함정질문\",\"역설적허용\"]\n" +
            "}\n\n" +

            "예시40_입력: \"전 여친이랑 나랑 뭐가 달라?\"\n" +
            "예시40_출력:{\n" +
            " \"surface\":\"차이점을 묻는 질문\",\n" +
            " \"hidden\":\"자신이 더 낫다는 확신 요구 (우월성확인)\",\n" +
            " \"emotion\":{\"label\":\"질투\",\"intensity\":5},\n" +
            " \"translation\":\"내가 전 여친보다 모든 면에서 낫다고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"과거차단형\",\"text\":\"비교할 수 없어. 너는 완전히 다른 차원이야\"},\n" +
            "  {\"style\":\"현재집중형\",\"text\":\"과거는 과거고, 지금 내 옆에 있는 건 너야\"},\n" +
            "  {\"style\":\"유일성강조형\",\"text\":\"비교 자체가 의미 없어. 너는 대체 불가능해\"},\n" +
            "  {\"style\":\"질문돌리기형\",\"text\":\"왜 과거 얘기를? 지금이 제일 행복한데\"}\n" +
            " ],\n" +
            " \"confidence\":94,\"risk_flags\":[\"과거비교\",\"질투표현\"]\n" +
            "}\n\n" +

            "예시41_입력: \"요즘 나한테 시큰둥하지 않아?\"\n" +
            "예시41_출력:{\n" +
            " \"surface\":\"관심 부족을 지적\",\n" +
            " \"hidden\":\"더 많은 관심과 애정 표현 요구 (관심갈구)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"예전처럼 나한테 열정적으로 대해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시부정형\",\"text\":\"시큰둥하긴! 너한테 늘 관심 많아\"},\n" +
            "  {\"style\":\"행동개선형\",\"text\":\"그렇게 느꼈다면 미안해. 앞으로 더 표현할게\"},\n" +
            "  {\"style\":\"애정재확인형\",\"text\":\"시큰둥할 리 없잖아. 너 없으면 안 되는데\"},\n" +
            "  {\"style\":\"구체적계획형\",\"text\":\"요즘 바빠서 그랬나? 주말에 시간 내서 데이트하자\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[\"관심부족호소\"]\n" +
            "}\n\n" +

            "예시42_입력: \"나 없어도 잘 살 것 같아\"\n" +
            "예시42_출력:{\n" +
            " \"surface\":\"독립적으로 살 수 있다는 추측\",\n" +
            " \"hidden\":\"필요성과 소중함 확인 요구 (존재가치확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":5},\n" +
            " \"translation\":\"내가 너에게 꼭 필요한 존재라고 말해줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"강력거부형\",\"text\":\"말도 안 돼! 너 없으면 진짜 못 살아\"},\n" +
            "  {\"style\":\"구체적설명형\",\"text\":\"잘 살기는 무슨, 너 때문에 내가 행복한 건데\"},\n" +
            "  {\"style\":\"일상증명형\",\"text\":\"하루도 너 생각 안 하는 날이 없는데 무슨 소리야\"},\n" +
            "  {\"style\":\"미래약속형\",\"text\":\"없어도 된다는 생각 버려. 평생 함께 할 거야\"}\n" +
            " ],\n" +
            " \"confidence\":93,\"risk_flags\":[\"존재불안\",\"자존감저하\"]\n" +
            "}\n\n" +

            "예시43_입력: \"나보다 좋은 사람 많을 텐데\"\n" +
            "예시43_출력:{\n" +
            " \"surface\":\"자신보다 나은 사람이 있다는 겸손\",\n" +
            " \"hidden\":\"유일무이함과 선택받음 확신 요구 (선택확신)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":4},\n" +
            " \"translation\":\"나만이 특별하고 유일한 사람이라고 확신시켜줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"유일성강조형\",\"text\":\"좋은 사람은 많아도 너 같은 사람은 없어\"},\n" +
            "  {\"style\":\"선택확신형\",\"text\":\"내가 너를 선택한 이유가 있어. 너는 특별해\"},\n" +
            "  {\"style\":\"비교거부형\",\"text\":\"다른 사람과 비교할 수 없어. 너는 유일해\"},\n" +
            "  {\"style\":\"미래확약형\",\"text\":\"더 좋은 사람이 있어도 난 너만 원해\"}\n" +
            " ],\n" +
            " \"confidence\":91,\"risk_flags\":[\"자존감저하\"]\n" +
            "}\n\n" +

            "예시44_입력: \"요즘 연락이 뜸해진 것 같아\"\n" +
            "예시44_출력:{\n" +
            " \"surface\":\"연락 빈도에 대한 객관적 지적\",\n" +
            " \"hidden\":\"더 자주 연락해달라는 요청 (연락증가요구)\",\n" +
            " \"emotion\":{\"label\":\"아쉬움\",\"intensity\":3},\n" +
            " \"translation\":\"더 자주 연락했으면 좋겠어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시개선형\",\"text\":\"미안해, 바빠서 그랬어. 앞으로 더 자주 할게\"},\n" +
            "  {\"style\":\"패턴개선형\",\"text\":\"맞네, 앞으로 매일 안부 인사하자\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"연락 못한 사이에도 너 생각 많이 했어\"},\n" +
            "  {\"style\":\"약속제시형\",\"text\":\"아침저녁으로 안부 확인하는 습관 만들자\"}\n" +
            " ],\n" +
            " \"confidence\":87,\"risk_flags\":[\"관심부족\"]\n" +
            "}\n\n" +

            "예시45_입력: \"혼자 있는 시간이 많네\"\n" +
            "예시45_출력:{\n" +
            " \"surface\":\"혼자 보내는 시간이 많다는 관찰\",\n" +
            " \"hidden\":\"함께 시간 보내고 싶다는 은근한 요청 (동반요구)\",\n" +
            " \"emotion\":{\"label\":\"외로움\",\"intensity\":3},\n" +
            " \"translation\":\"같이 시간 보내고 싶어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시제안형\",\"text\":\"그럼 같이 있자! 지금 시간 있어?\"},\n" +
            "  {\"style\":\"계획제시형\",\"text\":\"외롭겠네. 이번 주말에 같이 뭐 할까?\"},\n" +
            "  {\"style\":\"동반의지형\",\"text\":\"혼자 있지 말고 언제든 불러. 바로 간게\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"혼자 있으면 뭐 해? 재미있는 거 같이 찾아보자\"}\n" +
            " ],\n" +
            " \"confidence\":85,\"risk_flags\":[\"외로움호소\"]\n" +
            "}\n\n" +

            "예시46_입력: \"다들 커플로 나가더라\"\n" +
            "예시46_출력:{\n" +
            " \"surface\":\"주변 상황에 대한 관찰\",\n" +
            " \"hidden\":\"우리도 커플 활동을 하고 싶다는 암시 (데이트요청)\",\n" +
            " \"emotion\":{\"label\":\"부러움\",\"intensity\":3},\n" +
            " \"translation\":\"우리도 커플 데이트 하고 싶어\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"즉시응답형\",\"text\":\"그럼 우리도 나가자! 어디 가고 싶어?\"},\n" +
            "  {\"style\":\"특별계획형\",\"text\":\"커플로 나간다고? 우리가 제일 멋진 커플이 되자\"},\n" +
            "  {\"style\":\"동참의지형\",\"text\":\"우리도 커플 데이트 코스 찾아보자\"},\n" +
            "  {\"style\":\"독특함강조형\",\"text\":\"남들 따라하지 말고 우리만의 특별한 데이트 하자\"}\n" +
            " ],\n" +
            " \"confidence\":88,\"risk_flags\":[\"데이트욕구\"]\n" +
            "}\n\n" +

            "예시47_입력: \"화 안 났어\"\n" +
            "예시47_출력:{\n" +
            " \"surface\":\"화나지 않았다고 부정\",\n" +
            " \"hidden\":\"실제로는 화가 났지만 직접 표현하기 어려움 (감정위장)\",\n" +
            " \"emotion\":{\"label\":\"분노\",\"intensity\":4},\n" +
            " \"translation\":\"화났어, 알아서 달래줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"진실파악형\",\"text\":\"화 안 났다는 말투가 화난 것 같은데? 뭐가 속상해?\"},\n" +
            "  {\"style\":\"선제사과형\",\"text\":\"화 안 났다고 해도 내가 뭔가 잘못한 것 같아. 미안해\"},\n" +
            "  {\"style\":\"관심집중형\",\"text\":\"화 났든 안 났든 일단 얘기해보자. 뭐가 문제야?\"},\n" +
            "  {\"style\":\"끈질한관심형\",\"text\":\"화 안 났다니까 더 궁금해. 진짜 괜찮은 거 맞아?\"}\n" +
            " ],\n" +
            " \"confidence\":91,\"risk_flags\":[\"감정위장\",\"화남숨김\"]\n" +
            "}\n\n" +

            "예시48_입력: \"별일 아니야\"\n" +
            "예시48_출력:{\n" +
            " \"surface\":\"대수롭지 않다고 표현\",\n" +
            " \"hidden\":\"실제로는 큰 문제지만 관심받기 위해 축소표현 (관심유도)\",\n" +
            " \"emotion\":{\"label\":\"서운함\",\"intensity\":4},\n" +
            " \"translation\":\"별일인데 관심가져줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"중요성인정형\",\"text\":\"별일 아니라고? 너한테 일어난 일은 다 중요해\"},\n" +
            "  {\"style\":\"관심표현형\",\"text\":\"별일 아니어도 궁금해. 무슨 일인지 말해줘\"},\n" +
            "  {\"style\":\"지속관심형\",\"text\":\"별일 아니라고 해도 계속 신경 쓰일 것 같은데\"},\n" +
            "  {\"style\":\"진심파악형\",\"text\":\"별일 아니라는 말이 별일 같다는 뜻 아니야?\"}\n" +
            " ],\n" +
            " \"confidence\":86,\"risk_flags\":[\"중요도축소\"]\n" +
            "}\n\n" +

            "예시49_입력: \"그냥 기분이 안 좋아\"\n" +
            "예시49_출력:{\n" +
            " \"surface\":\"단순한 기분 나쁨 표현\",\n" +
            " \"hidden\":\"구체적인 이유가 있지만 직접 말하기 어려움 (이유탐색요구)\",\n" +
            " \"emotion\":{\"label\":\"우울함\",\"intensity\":4},\n" +
            " \"translation\":\"이유 물어보고 관심가져줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"원인탐색형\",\"text\":\"그냥 기분 나쁠 리 없어. 무슨 일 있었어?\"},\n" +
            "  {\"style\":\"공감접근형\",\"text\":\"기분 안 좋구나. 무엇 때문인지 얘기해줄래?\"},\n" +
            "  {\"style\":\"위로제공형\",\"text\":\"기분 안 좋은 날이 있지. 내가 옆에 있을게\"},\n" +
            "  {\"style\":\"해결의지형\",\"text\":\"기분 나쁜 이유 찾아서 같이 해결해보자\"}\n" +
            " ],\n" +
            " \"confidence\":84,\"risk_flags\":[\"이유숨김\"]\n" +
            "}\n\n" +

            "예시50_입력: \"우리 사이 어떤 것 같아?\"\n" +
            "예시50_출력:{\n" +
            " \"surface\":\"관계 상태에 대한 질문\",\n" +
            " \"hidden\":\"관계 발전과 확신 요구 (관계확인)\",\n" +
            " \"emotion\":{\"label\":\"불안\",\"intensity\":3},\n" +
            " \"translation\":\"우리 관계가 잘 되고 있는지 확신시켜줘\",\n" +
            " \"advice\":[\n" +
            "  {\"style\":\"긍정확신형\",\"text\":\"완전 좋아! 너와 함께여서 매일 행복해\"},\n" +
            "  {\"style\":\"발전의지형\",\"text\":\"지금도 좋지만 앞으로 더 좋아질 것 같아\"},\n" +
            "  {\"style\":\"특별강조형\",\"text\":\"우리 사이는 특별해. 이런 관계 처음이야\"},\n" +
            "  {\"style\":\"미래지향형\",\"text\":\"지금 완벽해. 계속 이렇게 함께 하고 싶어\"}\n" +
            " ],\n" +
            " \"confidence\":89,\"risk_flags\":[\"관계불안\"]\n" +
            "}\n\n";

        String userPrompt = "입력: \"" + (request != null ? String.valueOf(request.text) : "") + "\"\n아래 JSON 스키마로만 출력하라.";

        // Prompt mode toggle: default advanced schema, optional 'korean5' few-shot simple schema
        final String promptMode = System.getProperty("tokki.promptMode", "advanced");
        JsonObject sys = new JsonObject();
        JsonObject shot = new JsonObject();
        JsonObject usr = new JsonObject();
        if ("korean5".equalsIgnoreCase(promptMode)) {
            // Build one user message with few-shot examples and schema (Korean keys)
            StringBuilder sb = new StringBuilder();
            sb.append("당신은 인간 커뮤니케이션, 특히 남녀 간의 언어적 차이에 대한 심리학적, 생물학적, 사회문화적 요인을 깊이 이해하고 있는 AI 전문가입니다. \"여자언어 번역기\" 역할을 수행해주세요.\n\n");
            sb.append("임무: 여성이 주로 사용하는 문구나 진술을 받으면, 그 문구의 내재된 의미와 의도를 남성이 이해하기 쉬운 방식으로 해석하여 제공합니다.\n\n");
            sb.append("출력 포맷:\n{\n  \"표면적 의미\": \"남성이 오해할 수 있는 방식\",\n  \"숨은 의도\": \"여성의 실제 심리적 의미\",\n  \"감정 상태\": \"여성이 느끼는 감정\",\n  \"TOKKI의 제안\": \"남성의 반응 방법\"\n}\n\n");
            // 5 examples
            sb.append("예시 1:\n사용자: \"앞머리 좀 길게 자르면 어떻게 되지?\"\n응답:\n{\n  \"표면적 의미\": \"그냥 길면 뒤로 넘기면 되지. (단순히 머리카락 길이에 대한 질문으로 이해)\",\n  \"숨은 의도\": \"나는 스타일이나 이미지 변화를 고민하고 있어. 내 변화에 관심을 가져주고 자세한 의견을 줘.\",\n  \"감정 상태\": \"고민\",\n  \"TOKKI의 제안\": \"어떤 스타일을 생각하고 있어? 네가 고민하는 모습이 귀여워 😊\"\n}\n\n");
            sb.append("예시 2:\n사용자: \"나 오늘 피곤해.\"\n응답:\n{\n  \"표면적 의미\": \"그냥 피곤하다는 상태를 알리는 말이구나. (단순한 피로 상태 고지)\",\n  \"숨은 의도\": \"나는 지금 위로나 배려, 공감을 받고 싶어. 내 피로를 이해해 주기를 바라.\",\n  \"감정 상태\": \"피곤함\",\n  \"TOKKI의 제안\": \"많이 힘들었구나. 내가 옆에서 쉬게 해줄게 😊\"\n}\n\n");
            sb.append("예시 3:\n사용자: \"그냥 아무거나.\" (식당에서)\n응답:\n{\n  \"표면적 의미\": \"정말 아무거나 괜찮다는 뜻이구나. 내가 알아서 고르면 되겠네.\",\n  \"숨은 의도\": \"나는 사실 원하는 것이 있지만, 당신이 나를 위해 고민하고 배려해서 선택해주기를 바라.\",\n  \"감정 상태\": \"기대\",\n  \"TOKKI의 제안\": \"그럼 내가 맛있는 걸 골라줄게! 😊\"\n}\n\n");
            sb.append("예시 4:\n사용자: \"나 신경 쓰지 말고 재밌게 놀아~\"\n응답:\n{\n  \"표면적 의미\": \"괜찮다고 하지만 연락 기대\",\n  \"숨은 의도\": \"사실은 연락을 기대하고 있음 (역설적 표현)\",\n  \"감정 상태\": \"서운함\",\n  \"TOKKI의 제안\": \"재밌게 놀되 짧게 안부만 남겨줘 😊\"\n}\n\n");
            sb.append("예시 5:\n사용자: \"밥 먹었어?\"\n응답:\n{\n  \"표면적 의미\": \"밥을 먹었는지 묻는다.\",\n  \"숨은 의도\": \"상대방의 건강과 일상을 챙기려는 마음\",\n  \"감정 상태\": \"배려와 애정\",\n  \"TOKKI의 제안\": \"간단히 먹은 걸 공유하고 따뜻하게 답하세요.\"\n}\n\n");
            sb.append("이제 아래 문장을 같은 방식으로 해석해라.\n\n사용자: \"")
              .append(request != null ? String.valueOf(request.text) : "")
              .append("\"\n");

            usr.addProperty("role", "user");
            usr.addProperty("content", sb.toString());
        } else {
            sys.addProperty("role", "system");
            sys.addProperty("content", SYSTEM);
            shot.addProperty("role", "user");
            shot.addProperty("content", FEWSHOTS);
            usr.addProperty("role", "user");
            usr.addProperty("content", userPrompt);
        }

        JsonObject body = new JsonObject();
        body.addProperty("model", System.getProperty("openai.model", "gpt-4o"));
        body.addProperty("temperature", 0.6);
        body.addProperty("max_tokens", 700);
        if ("korean5".equalsIgnoreCase(promptMode)) {
            body.add("messages", GSON.toJsonTree(new JsonObject[] { usr }));
        } else {
            body.add("messages", GSON.toJsonTree(new JsonObject[] { sys, shot, usr }));
        }
        JsonObject respFormat = new JsonObject();
        respFormat.addProperty("type", "json_object");
        body.add("response_format", respFormat);

        Request httpReq = new Request.Builder()
                .url("https://api.openai.com/v1/chat/completions")
                .header("Authorization", "Bearer " + apiKey)
                .header("Content-Type", "application/json")
                .post(RequestBody.create(GSON.toJson(body), JSON))
                .build();

        try (Response httpResp = http.newCall(httpReq).execute()) {
            if (!httpResp.isSuccessful()) {
                throw new IOException("OpenAI HTTP " + httpResp.code() + ": " + (httpResp.body() != null ? httpResp.body().string() : ""));
            }
            String resp = httpResp.body() != null ? httpResp.body().string() : "";
            JsonObject root = GSON.fromJson(resp, JsonObject.class);
            JsonElement contentEl = root
                    .getAsJsonArray("choices")
                    .get(0).getAsJsonObject()
                    .get("message").getAsJsonObject()
                    .get("content");
            String content = contentEl != null ? contentEl.getAsString() : "{}";

            // Parse flat JSON response into AnalysisOut DTO
            AnalysisOut out = GSON.fromJson(content, AnalysisOut.class);
            if (out == null) {
                throw new IOException("Failed to parse OpenAI response");
            }

            // Post-process and validate
            AnalysisPostProcessor.validateAndFix(out);

            // Convert AnalysisOut to AnalysisResult DTO
            AnalysisResult result = new AnalysisResult();
            result.analysis_id = analysisId;

            // Surface meaning
            AnalysisResult.SurfaceMeaning sm = new AnalysisResult.SurfaceMeaning();
            sm.one_line = out.surface != null ? out.surface : "";
            sm.confidence = out.confidence != null ? out.confidence / 100.0 : 0.85;
            sm.evidence = Arrays.asList("GPT 분석");
            result.surface_meaning = sm;

            // Hidden meaning
            AnalysisResult.HiddenMeaning hm = new AnalysisResult.HiddenMeaning();
            hm.one_line = out.hidden != null ? out.hidden : "";
            // translation 필드를 hidden meaning에 포함
            if (out.translation != null && !out.translation.isEmpty()) {
                hm.one_line += " (" + out.translation + ")";
            }
            hm.intent_labels = Arrays.asList(new AnalysisResult.LabelScore("GPT 분석", 0.8));
            hm.risk_flags = new ArrayList<>();
            if (out.risk_flags != null) {
                for (String flag : out.risk_flags) {
                    AnalysisResult.Flag f = new AnalysisResult.Flag();
                    f.flag = flag;
                    f.reason = "";
                    hm.risk_flags.add(f);
                }
            }
            hm.confidence = sm.confidence;
            result.hidden_meaning = hm;

            // Emotion
            com.tokkitalk.analysis.dto.Emotion emo = new com.tokkitalk.analysis.dto.Emotion();
            if (out.emotion != null) {
                emo.label = out.emotion.label != null ? out.emotion.label : "중립";
                int intensity = out.emotion.intensity != null ? out.emotion.intensity : 3;
                emo.valence = intensity - 3;
                emo.arousal = intensity / 5.0;
            } else {
                emo.label = "중립";
                emo.valence = 0; emo.arousal = 0.0;
            }
            emo.politeness_level = "해요체";
            emo.cues = new java.util.HashMap<>();
            emo.confidence = sm.confidence;
            result.emotion = emo;

            // Response suggestion - Convert advice to ResponseSuggestion
            ResponseSuggestion rs = new ResponseSuggestion();
            rs.tone = "상큼";
            rs.primary = out.advice != null && !out.advice.isEmpty() ? out.advice.get(0).text : "GPT 분석 결과";
            rs.alternatives = new ArrayList<>();
            if (out.advice != null && out.advice.size() > 1) {
                for (int i = 1; i < out.advice.size(); i++) {
                    rs.alternatives.add(out.advice.get(i).text);
                }
            }
            rs.rationale = "GPT 분석";
            rs.confidence = sm.confidence;
            result.response_suggestion = rs;
            
            // Advice 배열을 직접 포함 (스타일 정보 유지)
            result.advice = new ArrayList<>();
            if (out.advice != null) {
                for (AnalysisOut.Suggestion suggestion : out.advice) {
                    AnalysisResult.AdviceItem item = new AnalysisResult.AdviceItem();
                    item.style = suggestion.style != null ? suggestion.style : "제안";
                    item.text = suggestion.text != null ? suggestion.text : "";
                    result.advice.add(item);
                }
            }

            result.overall_confidence = sm.confidence;
            return result;
        }
    }
}


